name: Check Process

on:
  # main ブランチ への Pull Request を対象にする
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: Run Flutter Lints
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Flutter SDKをセットアップ
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # 必要なパッケージをインストール
      - name: Install dependencies
        run: flutter pub get

      # flutter analyze を実行し、結果をログに出力
      - name: Run Flutter Analyze
        run: |
          flutter analyze --no-pub > lint-report.txt || true

      # GitHubアノテーション用にlint結果を出力
      - name: Annotate Lint Issues
        run: |
          while IFS= read -r line; do
            if [[ $line =~ ^([^:]+):([0-9]+):([0-9]+):[[:space:]]+(error|warning):[[:space:]]+(.*)$ ]]; then
              FILE=${BASH_REMATCH[1]}
              LINE=${BASH_REMATCH[2]}
              COLUMN=${BASH_REMATCH[3]}
              LEVEL=${BASH_REMATCH[4]}
              MESSAGE=${BASH_REMATCH[5]}
              echo "::${LEVEL} file=$FILE,line=$LINE,col=$COLUMN::${MESSAGE}"
            fi
          done < lint-report.txt
